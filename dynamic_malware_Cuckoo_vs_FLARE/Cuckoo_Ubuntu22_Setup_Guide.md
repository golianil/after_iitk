Cuckoo Sandbox on Ubuntu 22.04 LTS - Complete Setup Guide (2025)
=================================================================

This guide explains how to set up Cuckoo Sandbox on Ubuntu 22.04 LTS as a host for dynamic malware analysis.
It covers host requirements, installation steps (KVM/libvirt), installing Cuckoo (Python3 variant where applicable),
guest VM prep, networking, common pitfalls, and basic usage. Use only in isolated lab environments.

IMPORTANT SAFETY & ETHICS
- ONLY analyze malware in isolated, controlled networks (host-only or air-gapped).
- Do not expose guests or C2 infrastructure to the public Internet.
- Take snapshots before running any sample. Keep logs and hashes of samples.
- Ensure compliance with software licenses when using Windows ISOs.

Table of Contents
1. Overview & Variants
2. Host Requirements
3. Prep the Ubuntu 22.04 host
4. Install virtualization (KVM/libvirt) and helper tools
5. Create a dedicated cuckoo user & Python virtualenv
6. Install Cuckoo (Cuckoo v2 or Cuckoo3 guidance)
7. Configure DB (PostgreSQL) and services
8. Prepare and instrument guest VMs (Windows examples)
9. Networking & PCAP capture
10. Run a simple analysis
11. Troubleshooting & tips
12. Useful commands & references

1. Overview & Variants
----------------------
- Cuckoo v2.x historically supported Python 2; community forks and the official docs now describe Python3-friendly installs.
- Cuckoo3 (Community/Cert-EE) is a modern Python3 rewrite; check the repo compatibility (Python 3.10+).
- This guide focuses on Ubuntu 22.04 with a Python3-based Cuckoo (install from source or pip), using KVM/libvirt for guest VMs.

2. Host Requirements
--------------------
- Ubuntu 22.04 LTS (server or desktop)
- CPU with virtualization support (VT-x/AMD-V)
- RAM: 16â€“32 GB recommended
- Disk: 200+ GB (snapshots, pcaps, reports)
- Network: host-only bridge for analysis VMs; optional controlled proxy for selective internet access

3. Prep the Ubuntu 22.04 host
-----------------------------
Update system and install base packages:
```bash
sudo apt update && sudo apt upgrade -y
sudo apt install -y git curl wget build-essential
```

4. Install virtualization (KVM/libvirt) and helper tools
--------------------------------------------------------
Install KVM/QEMU and libvirt:
```bash
sudo apt install -y qemu-kvm libvirt-daemon-system libvirt-clients virtinst bridge-utils libguestfs-tools
# Optional GUI tools
sudo apt install -y virt-manager
# Packet capture and analysis (host)
sudo apt install -y tcpdump tshark
```
Add your user to libvirt/kvm groups (replace $USER if not using 'cuckoo'):
```bash
sudo usermod -aG libvirt,kvm $USER
# Log out/in for group changes to take effect
```

5. Create a dedicated cuckoo user & Python virtualenv
-----------------------------------------------------
It's best to run Cuckoo as a non-root user:
```bash
sudo adduser --gecos "" cuckoo
sudo usermod -aG libvirt,kvm cuckoo
sudo -i -u cuckoo bash
python3 -m venv ~/cuckoo-venv
source ~/cuckoo-venv/bin/activate
```

6. Install Cuckoo (choose v2 or Cuckoo3)
---------------------------------------
Option A: Install stable Cuckoo (from PyPI / GitHub)
```bash
# Inside virtualenv as cuckoo user
pip install --upgrade pip setuptools wheel
# Recommended: install from source to get latest updates
git clone https://github.com/cuckoosandbox/cuckoo.git ~/cuckoo
cd ~/cuckoo
pip install -r requirements.txt || true
pip install -e .
```
Option B: Install Cuckoo3 (Python3 rewrite) - check repo for compatibility
```bash
git clone https://github.com/cert-ee/cuckoo3.git ~/cuckoo3
cd ~/cuckoo3
python3 -m pip install -r requirements.txt
python3 -m pip install -e .
```
Notes:
- Some community modules (mitmproxy, capstone, yara) may need separate virtualenvs or system packages.
- Follow the specific README of the chosen repo for exact dependency versions.

7. Configure DB (PostgreSQL) and services
-----------------------------------------
Install PostgreSQL and create DB/user (example):
```bash
sudo apt install -y postgresql postgresql-contrib libpq-dev
sudo -u postgres psql -c "CREATE USER cuckoo WITH PASSWORD 'cuckoopass';"
sudo -u postgres psql -c "CREATE DATABASE cuckoodb OWNER cuckoo;"
# Adjust connection string in cuckoo.conf
```
Alternatively, MongoDB is used in legacy setups - prefer PostgreSQL for modern installs.

8. Prepare and instrument guest VMs (Windows)
---------------------------------------------
Guest VMs should be isolated and snapshot-ready. Example steps to make Windows guest:
- Create a Windows VM using virt-manager or virt-install with a bridged or host-only network.
- Install Python (2.7 for old Cuckoo guest agent, or follow guest agent docs for Python3).
- Install the Cuckoo guest agent (from Cuckoo repo's agent directory). Example on Windows guest:
  - Copy `agent.py` and supporting files.
  - Install Python and required modules: `pip install pywin32 pillow`
  - Configure agent config (listen address, ports).
  - Create a Windows service or run the agent on startup.
- Take a snapshot named `clean` after installation and before running samples.

9. Networking & PCAP capture
---------------------------
- Prefer a dedicated libvirt network or bridge (e.g., `virbr1`) with no external NAT.
- Configure Cuckoo to capture on the host interface that sees guest traffic (edit `cuckoo.conf`, set `pcap` interface).
- If limited internet access is required for malware to fetch payloads, proxy it via a controlled Squid or mitmproxy VM and log traffic.

10. Run a simple analysis
-------------------------
From the cuckoo user venv:
```bash
# ensure database & configs are correct
cuckoo --help
# submit a sample
cuckoo submit /path/to/sample.exe
# list tasks
cuckoo --tasks
# view reports (html/json) in results/ or via cuckoo-web
```
Start the web UI (if installed) via `cuckoo web` or follow web UI docs.

11. Troubleshooting & tips
--------------------------
- If virtual machines won't start: check libvirt logs (`/var/log/libvirt`) and qemu logs.
- If PCAPs are empty: ensure the capture interface is correct and capture permissions; run tcpdump on host to validate.
- Use snapshots aggressively; revert after each analysis.
- Keep sample names hashed and store original sample in a safe, separate store.

12. Useful commands & references
--------------------------------
Commands:
- Start/stop libvirt: `sudo systemctl status libvirtd`
- List VMs: `virsh list --all`
- Snapshot VM: `virsh snapshot-create-as <vmname> clean "clean snapshot"`
- Capture on host (debug): `sudo tcpdump -i virbr1 -w /tmp/guest.pcap`
References:
- https://cuckoo.readthedocs.io/
- Cuckoo GitHub: https://github.com/cuckoosandbox/cuckoo
- Cuckoo3 repo: https://github.com/cert-ee/cuckoo3

Appendix: Sample minimal cuckoo.conf snippets
--------------------------------------------
# (Placeholders; edit paths/DB accordingly)
[database]
# For PostgreSQL
connection = postgresql://cuckoo:cuckoopass@localhost:5432/cuckoodb

[processing]
timeout = 120
memory_dump = yes

[virustotal]
api_key = YOUR_API_KEY_HERE

[machines]
# machines.conf manages guest mappings; see docs for full examples

Security reminder: Always follow legal/ethical rules and use isolated labs.

# FLARE_VM_custom_install.ps1
# Run in an elevated PowerShell session on a fresh Windows 10/11 VM.
# This script installs Chocolatey, then runs the official FLARE-VM installer and additional custom packages.
# Always review and run in an isolated, snapshot-enabled VM.

Set-ExecutionPolicy Bypass -Scope Process -Force

# Install Chocolatey
if (!(Get-Command choco -ErrorAction SilentlyContinue)) {
    Write-Host "Installing Chocolatey..."
    iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
}

# Install Boxstarter (optional)
if (!(Get-Command boxstarter -ErrorAction SilentlyContinue)) {
    Write-Host "Installing Boxstarter..."
    choco install boxstarter -y
}

# Run the official FLARE-VM installer (verify URL on repo before running)
Write-Host "Running FLARE-VM official installer (may take long)..."
# Note: ensure TLS/HTTPS is enabled and URL is correct at time of use
iex ((New-Object System.Net.WebClient).DownloadString('https://raw.githubusercontent.com/mandiant/flare-vm/master/install.ps1'))

# Custom additional packages to install via Chocolatey
$packages = @(
    "7zip",
    "putty",
    "sysinternals",
    "gnuwin32-coreutils",
    "python3",
    "yara",
    "yara-python",
    "pe-sieve",
    "ripgrep",
    "jq-win64",
    "gdb",
    "winrid",
    "autoruns",
    "processhacker",
    "procmon",
    "procexp",
    "windsor",
    "wireshark",
    "ghidra",
    "x64dbg"
)

Write-Host "Installing custom packages (this will take time)..."
foreach ($p in $packages) {
    choco install $p -y --no-progress || Write-Host "Package $p failed to install; continue..."
}

# Post-install hints
Write-Host "Post-install steps:"
Write-Host "  - Create a VM snapshot now (clean baseline)."
Write-Host "  - Configure symbol servers for WinDbg (e.g., srv*C:\\symbols*https://msdl.microsoft.com/download/symbols)."
Write-Host "  - Disable Host-Guest clipboard and drag-drop if using VMware/VirtualBox (to avoid accidental host contamination)."
